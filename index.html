<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Todo List App (MDC Fixed)</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@material/web@latest/dist/material-web.min.css">
<style>
body { font-family: Roboto, sans-serif; margin:0; overflow-x:hidden; }
header { display:flex; align-items:center; padding:0.5em; background:#6200ee; color:#fff; }
header h1 { flex:1; font-size:1.2rem; margin:0; }
.menu { position:fixed; top:0; left:0; width:300px; height:100%; background:#fff; z-index:1000; overflow-y:auto; transform:translateX(-100%); transition: transform 0.3s ease; box-shadow:2px 0 5px rgba(0,0,0,0.2); padding:1em; }
.menu.show { transform:translateX(0); }
.overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.3); z-index:900; }
.overlay.show { display:block; }
.list-item { display:flex; align-items:center; justify-content:space-between; padding:0.5em; border:1px solid #ccc; border-radius:4px; margin-bottom:0.5em; background:#fafafa; cursor:grab; }
.list-item.dragging { opacity:0.5; }
.repeat-toggle { display:flex; gap:0.3em; margin-bottom:0.5em; flex-wrap:wrap; }
.repeat-toggle button { flex:1; min-width:30px; }
.repeat-toggle button.active { background:#6200ee; color:#fff; }
.completion-tag { border-radius:4px; padding:0.2em 0.4em; color:#fff; font-size:0.8em; margin-left:0.5em; }
#trash { position:fixed; bottom:1em; right:1em; width:60px; height:60px; background:#e53935; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:2rem; color:#fff; z-index:1001; }
</style>
</head>
<body>

<header>
  <button onclick="toggleMenu()">‚ò∞</button>
  <h1>Todo List</h1>
</header>

<div class="overlay" id="overlay" onclick="toggleMenu()"></div>

<nav id="menu" class="menu">
  <label>Date: <input id="menuDate" type="date"></label>

  <h3>Create New List</h3>
  <input id="newListName" placeholder="List name">
  <select id="newListType">
    <option value="once">One-time</option>
    <option value="indef">Indefinite</option>
    <option value="future">Future</option>
    <option value="repeat">Repeats</option>
  </select>
  <div id="menuDaysInput" class="repeat-toggle" style="display:none">
    <button type="button" data-day="0">Sun</button>
    <button type="button" data-day="1">Mon</button>
    <button type="button" data-day="2">Tue</button>
    <button type="button" data-day="3">Wed</button>
    <button type="button" data-day="4">Thu</button>
    <button type="button" data-day="5">Fri</button>
    <button type="button" data-day="6">Sat</button>
  </div>
  <button onclick="createList()">Create List</button>

  <h3>Lists for Selected Date</h3>
  <div id="menuLists"></div>

  <h3 id="deletedTitle" style="display:none">Deleted Lists</h3>
  <div id="deletedLists"></div>
</nav>

<main style="padding:1em">
  <div id="lists"></div>
  <h2>Metrics</h2>
  <div id="metrics"></div>
  <h3>Last 7 Days</h3>
  <div id="weekMetrics"></div>
</main>

<div id="trash">üóëÔ∏è</div>

<script>
// STORAGE
const storage={save(k,v){localStorage.setItem(k,JSON.stringify(v));},load(k){try{return JSON.parse(localStorage.getItem(k)||"[]");}catch(e){return[];}}};
let lists=storage.load("lists"),states=storage.load("states"),deletedLists=[];

// DATE HELPERS
function formatDateLocal(d){const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),day=String(d.getDate()).padStart(2,'0');return `${y}-${m}-${day}`;}
function parseYMDToDate(s){const [y,m,d]=s.split('-').map(Number);return new Date(y,m-1,d);}
function todayStr(){return formatDateLocal(new Date());}

// MENU TOGGLE
function toggleMenu(){document.getElementById('menu').classList.toggle('show');document.getElementById('overlay').classList.toggle('show');}

// LIST STATE HELPERS
function getState(listId,date){let st=states.find(s=>s.listId===listId&&s.date===date);if(!st){st={listId,date,completed:{}};states.push(st);storage.save("states",states);}return st;}
function isActive(list,dateObj){const d=formatDateLocal(dateObj);if(list.type==="future"&&d<list.start) return false;if(d<list.start) return false;if(list.end&&d>list.end) return false;if(list.daysOfWeek&&!list.daysOfWeek.includes(dateObj.getDay())) return false;return true;}
function toggleItem(listId,itemId,date){const st=getState(listId,date);st.completed[itemId]=!st.completed[itemId];storage.save("states",states); renderMain(); renderMenu();}
function completionColor(p){if(p<=33) return 'red'; else if(p<=66) return 'orange'; else return 'green';}

// CRUD
function createList(){
  const name=document.getElementById('newListName').value.trim();
  if(!name) return;
  const type=document.getElementById('newListType').value;
  const date=document.getElementById('menuDate').value||todayStr();
  const days=[...document.querySelectorAll('#menuDaysInput button.active')].map(b=>+b.dataset.day);
  let start=date,end=null,daysOfWeek=null;if(type==="once") end=date;if(type==="repeat") daysOfWeek=days.length?days:null;
  lists.push({id:Date.now(),name,items:[],start,end,daysOfWeek,type});
  storage.save("lists",lists); document.getElementById('newListName').value=""; renderMenu(); renderMain();
}
function deleteList(listId){if(!confirm("Delete list?")) return; const idx=lists.findIndex(l=>l.id===listId); if(idx>=0){deletedLists.push(lists[idx]); lists.splice(idx,1); storage.save("lists",lists); renderMenu(); renderMain();}}
function undoDelete(){if(deletedLists.length===0) return; lists.push(deletedLists.pop()); storage.save("lists",lists); renderMenu(); renderMain();}

// REPEAT DAY TOGGLE
document.querySelectorAll('#menuDaysInput button').forEach(b=>b.onclick=()=>b.classList.toggle('active'));

// TYPE CHANGE
document.getElementById('newListType').onchange=function(){document.getElementById('menuDaysInput').style.display=this.value==="repeat"?"flex":"none";}

// MENU DATE
document.getElementById('menuDate').onchange=function(){renderMenu(); renderMain();}

// RENDER MENU
function renderMenu(){
  const dateStr=document.getElementById('menuDate').value||todayStr();
  const container=document.getElementById('menuLists'); container.innerHTML="";
  lists.filter(l=>isActive(l,parseYMDToDate(dateStr))).forEach(l=>{
    const div=document.createElement('div'); div.style.display="flex"; div.style.justifyContent="space-between";
    div.textContent=l.name; 
    const del=document.createElement('button'); del.textContent="‚ùå"; del.onclick=()=>deleteList(l.id); div.appendChild(del);
    container.appendChild(div);
  });
  const deletedContainer=document.getElementById('deletedLists'); deletedContainer.innerHTML="";
  if(deletedLists.length>0){document.getElementById('deletedTitle').style.display="block"; deletedLists.forEach(d=>{
    const div=document.createElement('div'); div.style.display="flex"; div.style.justifyContent="space-between";
    div.textContent=d.name; const undo=document.createElement('button'); undo.textContent="‚Ü©Ô∏è"; undo.onclick=undoDelete; div.appendChild(undo); deletedContainer.appendChild(div);
  });}else{document.getElementById('deletedTitle').style.display="none";}
}

// RENDER MAIN
function renderMain(){
  const dateStr=document.getElementById('menuDate').value||todayStr();
  const container=document.getElementById('lists'); container.innerHTML="";
  lists.filter(l=>isActive(l,parseYMDToDate(dateStr))).forEach(l=>{
    const div=document.createElement('div'); div.style.marginBottom="1em";
    const h3=document.createElement('h3'); h3.textContent=l.name; div.appendChild(h3);
    const ul=document.createElement('div'); ul.style.display="flex"; ul.style.flexDirection="column"; ul.style.gap="0.3em";
    l.items.forEach(it=>{
      const li=document.createElement('div'); li.className="list-item"; li.draggable=true;
      const cb=document.createElement('input'); cb.type="checkbox"; cb.checked=!!getState(l.id,dateStr).completed[it.id]; cb.onclick=e=>{e.stopPropagation(); toggleItem(l.id,it.id,dateStr);}; li.appendChild(cb);
      const span=document.createElement('span'); span.textContent=it.text;
      let pressTimer=null; span.addEventListener('mousedown',()=>{pressTimer=setTimeout(()=>{editItem(l.id,it.id,span)},500);}); span.addEventListener('mouseup',()=>clearTimeout(pressTimer));
      li.appendChild(span);
      li.addEventListener('dragstart',e=>{li.classList.add('dragging'); e.dataTransfer.setData('text/plain', JSON.stringify({listId:l.id,itemId:it.id}));});
      li.addEventListener('dragend',()=>li.classList.remove('dragging'));
      ul.appendChild(li);
    });
    div.appendChild(ul); container.appendChild(div);
  });
}

// EDIT ITEM
function editItem(listId,itemId,span){
  const l=lists.find(li=>li.id===listId); const it=l.items.find(i=>i.id===itemId);
  const input=document.createElement('input'); input.value=it.text;
  input.onblur=()=>{it.text=input.value; storage.save("lists",lists); renderMain();};
  input.onkeydown=e=>{if(e.key==='Enter'){it.text=input.value; storage.save("lists",lists); renderMain();}};
  span.replaceWith(input); input.focus();
}

// TRASH DROP
const trash=document.getElementById('trash'); trash.ondragover=e=>e.preventDefault();
trash.ondrop=e=>{const data=JSON.parse(e.dataTransfer.getData('text/plain')); const list=lists.find(l=>l.id===data.listId); list.items=list.items.filter(i=>i.id!==data.itemId); storage.save("lists",lists); renderMain();}

// INIT
window.onload=function(){document.getElementById('menuDate').value=todayStr(); renderMenu(); renderMain();}
</script>

</body>
</html>
